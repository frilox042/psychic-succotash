---
date: 2020-09-17T15:29
---

# Serialization

## Cap'n Proto

[https://capnproto.org/](https://capnproto.org/)

Install from arch package

```shell
$ yay -S capnproto
```

### C++

Generate C++ headers

```shell
$ capnpc test.capnp -o c++
```

```shell
$ tree
.
|____test.capnp.h
|____test.capnp
|____test.capnp.c++
```

### Python

Install from pip

```shell
$ pip install pycapnp
```

Run in python

```python
import capnp
<...>
ImportError: <...>/capnp.cpython-38-x86_64-linux-gnu.so: undefined symbol: _ZN2kj1_24TransformPromiseNodeBase7onReadyERNS0_5EventE
```

It does not seem to work well for python.

Also, it does not work by generating python files with classes like protobuf or flatbuffers does.
Those python files are helpful because they can be used for autocompletion while coding.
Cap'n Proto seems to only rely on reflection.

## Protobuf

[https://developers.google.com/protocol-buffers/](https://developers.google.com/protocol-buffers/)

Install from arch package

```shell
$ yay -S protobuf
```

### C++

Generate C++ headers

```shell
$ protoc test.proto --cpp_out=. 
```

```
$ tree
.
|____test.proto
|____test.pb.h
|____test.pb.cc
```

### Python

Generate python code

```shell
$ protoc test.proto --python_out=. 
```

```shell
$ tree
.
|____test_pb2.py
|____test.proto
```

#### Some Test

Install python protobuf package

```shell
$ pip install protobuf
```

Play with the generated code from proto file

```python
from test_pb2 import Person

person = Person()
person.IsInitialized() # False
p.id = 123
p.name = 'test'
person.IsInitialized() # True
p.SerializeToString()  # b'\n\x04test\x10{'
Person().FromString(p.SerializeToString()) == person # True
```

## Flatbuffers

[https://google.github.io/flatbuffers/](https://google.github.io/flatbuffers/)

```shell
$ yay -S flatbuffers
```

### C++

Generate C++ headers

```shell
$ flatc --cpp test.fbs 
```

```shell
tree
.
|____test_generated.h
|____test.fbs
```

### Python

Generate python code

```shell
$ flatc --python test.fbs 
```

```shell
tree
.
MyGame
|______init__.py
|____Sample
| |____Color.py
| |______init__.py
| |____Monster.py
| |____Weapon.py
| |____Equipment.py
| |____Vec3.py
|____test.fbs
```

#### Some Test

Install python flatbuffers package

```shell
$ pip install flatbuffers
```

Play with the generated code from proto file

```python
import flatbuffers
# Generated by `flatc`.
import MyGame.Sample.Color
import MyGame.Sample.Equipment
import MyGame.Sample.Monster
import MyGame.Sample.Vec3
import MyGame.Sample.Weapon

builder = flatbuffers.Builder(1024)

MyGame.Sample.Monster.MonsterStart(builder)
MyGame.Sample.Monster.MonsterAddHp(builder, 42)
monster = MyGame.Sample.Monster.MonsterEnd(builder)

builder.Finish(monster)

monster_serialized = builder.Output()

MyGame.Sample.Monster.Monster(builder, 100)
monster = MyGame.Sample.Monster.Monster.GetRootAsMonster(monster_serialized, 0)

monster.Hp() # 42
```

---

## Annexe

### File content

#### Cap'n Proto

```
@0x918572045ffb997c;

struct Person {
  name @0 :Text;
  birthdate @3 :Date;

  email @1 :Text;
  phones @2 :List(PhoneNumber);

  struct PhoneNumber {
    number @0 :Text;
    type @1 :Type;

    enum Type {
      mobile @0;
      home @1;
      work @2;
    }
  }
}

struct Date {
  year @0 :Int16;
  month @1 :UInt8;
  day @2 :UInt8;
}

```

#### Protobuf

```
syntax = "proto2";

message Person {
  required string name = 1;
  required int32 id = 2;
  optional string email = 3;
}
```

#### Flatbuffers

```
// Example IDL file for our monster's schema.
namespace MyGame.Sample;
enum Color:byte { Red = 0, Green, Blue = 2 }
union Equipment { Weapon } // Optionally add more tables.
struct Vec3 {
  x:float;
  y:float;
  z:float;
}
table Monster {
  pos:Vec3; // Struct.
  mana:short = 150;
  hp:short = 100;
  name:string;
  friendly:bool = false (deprecated);
  inventory:[ubyte];  // Vector of scalars.
  color:Color = Blue; // Enum.
  weapons:[Weapon];   // Vector of tables.
  equipped:Equipment; // Union.
  path:[Vec3];        // Vector of structs.
}
table Weapon {
  name:string;
  damage:short;
}
root_type Monster;
```